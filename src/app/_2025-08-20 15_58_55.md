### 

ç”¨æˆ·:
è®²è§£ä¸€ä¸‹web Audi0

Claude:


ç”¨æˆ·:
è®²è§£ä¸€ä¸‹web audio apiï¼Œå¦‚ä½•åˆ›å»ºï¼Œå¦‚ä½•è·å–éŸ³é‡ï¼Œæœ‰å“ªäº›ç»†èŠ‚

Claude:
ï¿½ï¿½äºä½ æä¾›çš„ä»£ç ï¼Œæˆ‘æ¥è¯¦ç»†è®²è§£ **Web Audio API** çš„æ ¸å¿ƒæ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼š

## 1. Web Audio API åŸºç¡€æ¦‚å¿µ

Web Audio API æ˜¯æµè§ˆå™¨æä¾›çš„é«˜çº§éŸ³é¢‘å¤„ç†æ¥å£ï¼Œå®ƒåŸºäº**éŸ³é¢‘å›¾ï¼ˆAudio Graphï¼‰**çš„æ¦‚å¿µï¼Œé€šè¿‡è¿æ¥ä¸åŒçš„éŸ³é¢‘èŠ‚ç‚¹æ¥å¤„ç†éŸ³é¢‘ã€‚

### æ ¸å¿ƒæ¶æ„
```
éŸ³é¢‘æº â†’ å¤„ç†èŠ‚ç‚¹ â†’ è¾“å‡ºè®¾å¤‡
Source â†’ Processing Nodes â†’ Destination
```

## 2. AudioContext - éŸ³é¢‘ä¸Šä¸‹æ–‡

```javascript
// åˆ›å»º AudioContextï¼ˆæ”¯æŒæµè§ˆå™¨å…¼å®¹ï¼‰
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// æ£€æŸ¥å’Œæ¢å¤çŠ¶æ€
if (audioContext.state === "suspended") {
  await audioContext.resume();
}
```

**AudioContext çš„é‡è¦å±æ€§ï¼š**
- `currentTime`: å½“å‰éŸ³é¢‘æ—¶é—´ï¼ˆç§’ï¼‰
- `state`: éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€ï¼ˆ`suspended` | `running` | `closed`ï¼‰
- `destination`: éŸ³é¢‘è¾“å‡ºèŠ‚ç‚¹ï¼ˆæ‰¬å£°å™¨ï¼‰

## 3. æ ¸å¿ƒéŸ³é¢‘èŠ‚ç‚¹ç±»å‹

### AudioBufferSourceNode - éŸ³é¢‘æºèŠ‚ç‚¹
```javascript
const source = audioContext.createBufferSource();
source.buffer = audioBuffer;           // è®¾ç½®éŸ³é¢‘æ•°æ®
source.loop = true;                   // å¾ªç¯æ’­æ”¾
source.playbackRate.value = 1.5;     // æ’­æ”¾é€Ÿåº¦
source.start(0, startTime);          // å¼€å§‹æ’­æ”¾
source.stop();                       // åœæ­¢æ’­æ”¾
```

### GainNode - éŸ³é‡æ§åˆ¶èŠ‚ç‚¹
```javascript
const gainNode = audioContext.createGain();
gainNode.gain.value = 0.7;                    // ç›´æ¥è®¾ç½®éŸ³é‡
gainNode.gain.setValueAtTime(0.5, when);      // åœ¨æŒ‡å®šæ—¶é—´è®¾ç½®éŸ³é‡
gainNode.gain.linearRampToValueAtTime(1.0, when + 2); // æ¸å˜éŸ³é‡
```

### AnalyserNode - åˆ†æèŠ‚ç‚¹
```javascript
const analyser = audioContext.createAnalyser();
analyser.fftSize = 256;              // FFT å¤§å°
analyser.frequencyBinCount;          // é¢‘ç‡æ•°æ®ç‚¹æ•°é‡

// è·å–é¢‘è°±æ•°æ®
const dataArray = new Uint8Array(analyser.frequencyBinCount);
analyser.getByteFrequencyData(dataArray);
```

## 4. éŸ³é¢‘æ•°æ®å¤„ç†

### åŠ è½½å’Œè§£ç éŸ³é¢‘
```javascript
async function loadAudio(url) {
  // 1. è·å–éŸ³é¢‘æ–‡ä»¶
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  
  // 2. è§£ç ä¸º AudioBuffer
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  
  return audioBuffer;
}
```

### AudioBuffer å±æ€§
```javascript
audioBuffer.duration;        // éŸ³é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
audioBuffer.sampleRate;      // é‡‡æ ·ç‡
audioBuffer.numberOfChannels; // å£°é“æ•°
```

## 5. èŠ‚ç‚¹è¿æ¥ï¼ˆéŸ³é¢‘å›¾ï¼‰

```javascript
// å…¸å‹çš„éŸ³é¢‘å¤„ç†é“¾
source.connect(gainNode);           // æº â†’ éŸ³é‡æ§åˆ¶
gainNode.connect(analyser);         // éŸ³é‡æ§åˆ¶ â†’ åˆ†æå™¨
analyser.connect(audioContext.destination); // åˆ†æå™¨ â†’ è¾“å‡º

// æˆ–è€…ç®€å†™
source.connect(gainNode).connect(analyser).connect(audioContext.destination);
```

## 6. ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶

Web Audio API æœ€å¤§çš„ä¼˜åŠ¿æ˜¯**ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶**ï¼š

```javascript
// åŸºäº AudioContext æ—¶é—´çš„ç²¾ç¡®è®¡ç®—
const startTime = audioContext.currentTime;
const elapsed = audioContext.currentTime - startTime;
const currentPlayTime = pausedTime + elapsed;

// ç²¾ç¡®çš„æ’­æ”¾è°ƒåº¦
source.start(audioContext.currentTime + 0.1, seekTime); // 0.1ç§’åå¼€å§‹ï¼Œä» seekTime ä½ç½®æ’­æ”¾
```

## 7. éŸ³é‡æ§åˆ¶çš„å‡ ç§æ–¹å¼

### çº¿æ€§éŸ³é‡æ§åˆ¶
```javascript
gainNode.gain.value = volume; // 0.0 åˆ° 1.0
```

### å¯¹æ•°éŸ³é‡æ§åˆ¶ï¼ˆæ›´ç¬¦åˆäººè€³æ„ŸçŸ¥ï¼‰
```javascript
function setLogarithmicVolume(gain, volume) {
  // å°†çº¿æ€§éŸ³é‡è½¬æ¢ä¸ºå¯¹æ•°éŸ³é‡
  const dbValue = volume === 0 ? -100 : 20 * Math.log10(volume);
  const linearValue = Math.pow(10, dbValue / 20);
  gain.value = linearValue;
}
```

### æ¸å˜éŸ³é‡æ§åˆ¶
```javascript
// æ·¡å…¥æ•ˆæœ
gainNode.gain.setValueAtTime(0, audioContext.currentTime);
gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 2);

// æ·¡å‡ºæ•ˆæœ
gainNode.gain.setValueAtTime(1, audioContext.currentTime);
gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);
```

## 8. é‡è¦çš„å®ç°ç»†èŠ‚

### èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
```javascript
// AudioBufferSourceNode åªèƒ½ä½¿ç”¨ä¸€æ¬¡
const source = audioContext.createBufferSource();
source.start(); // å¼€å§‹æ’­æ”¾
source.stop();  // åœæ­¢åï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±ä¸èƒ½å†ä½¿ç”¨äº†

// éœ€è¦é‡æ–°åˆ›å»ºæ–°çš„æºèŠ‚ç‚¹
const newSource = audioContext.createBufferSource();
```

### æš‚åœå’Œæ¢å¤çš„å®ç°
ç”±äº Web Audio API æ²¡æœ‰ç›´æ¥çš„æš‚åœåŠŸèƒ½ï¼Œéœ€è¦æ‰‹åŠ¨å®ç°ï¼š

```javascript
// æš‚åœï¼šè®°å½•å½“å‰æ—¶é—´ï¼Œåœæ­¢æ’­æ”¾
function pause() {
  const elapsed = audioContext.currentTime - startTime;
  pausedTime += elapsed;
  source.stop();
}

// æ¢å¤ï¼šä»æš‚åœä½ç½®é‡æ–°å¼€å§‹
function resume() {
  const newSource = audioContext.createBufferSource();
  newSource.buffer = audioBuffer;
  newSource.connect(gainNode);
  startTime = audioContext.currentTime;
  newSource.start(0, pausedTime); // ä»æš‚åœä½ç½®å¼€å§‹
}
```

### å†…å­˜ç®¡ç†
```javascript
// æ–­å¼€èŠ‚ç‚¹è¿æ¥ï¼Œé‡Šæ”¾å†…å­˜
source.disconnect();
gainNode.disconnect();

// å…³é—­ AudioContext
audioContext.close();
```

## 9. æµè§ˆå™¨å…¼å®¹æ€§æ³¨æ„äº‹é¡¹

```javascript
// 1. AudioContext æ„é€ å‡½æ•°å…¼å®¹
const AudioContext = window.AudioContext || window.webkitAudioContext;

// 2. ç”¨æˆ·äº¤äº’è¦æ±‚ï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
// AudioContext éœ€è¦åœ¨ç”¨æˆ·äº¤äº’åæ‰èƒ½å¯åŠ¨
document.addEventListener('click', async () => {
  if (audioContext.state === 'suspended') {
    await audioContext.resume();
  }
});

// 3. iOS Safari ç‰¹æ®Šå¤„ç†
// éœ€è¦åœ¨ç”¨æˆ·äº¤äº’ä¸­åˆ›å»ºå’Œå¯åŠ¨ AudioContext
```

## 10. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¤ç”¨ AudioContext**ï¼šæ•´ä¸ªåº”ç”¨å…±äº«ä¸€ä¸ª AudioContext
2. **åŠæ—¶æ–­å¼€è¿æ¥**ï¼šä¸ä½¿ç”¨çš„èŠ‚ç‚¹è¦ disconnect()
3. **é¢„åŠ è½½éŸ³é¢‘**ï¼šæå‰è§£ç å¸¸ç”¨çš„éŸ³é¢‘æ–‡ä»¶
4. **é¿å…é¢‘ç¹åˆ›å»ºèŠ‚ç‚¹**ï¼šå¯ä»¥åˆ›å»ºèŠ‚ç‚¹æ± å¤ç”¨

è¿™ä¸ª API çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒæä¾›äº†**ä¸“ä¸šçº§çš„éŸ³é¢‘å¤„ç†èƒ½åŠ›**ï¼Œå¯ä»¥å®ç°å®æ—¶éŸ³æ•ˆã€éŸ³é¢‘å¯è§†åŒ–ã€ç©ºé—´éŸ³é¢‘ç­‰é«˜çº§åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒäº†å¾ˆé«˜çš„æ€§èƒ½å’Œç²¾ç¡®åº¦ã€‚


ç”¨æˆ·:
è®²è§£ä¸€ä¸‹è¿™æ®µä»£ç ä¸­web audio apiï¼Œå¦‚ä½•åˆ›å»ºï¼Œå¦‚ä½•è·å–éŸ³é‡ç­‰åŠŸèƒ½ï¼Œè®²è§£ä¸€ä¸‹è¿™æ®µä»£ç ä¸­æœ‰å“ªäº›ç»†èŠ‚

Claude:
ï¿½ï¿½æ¥è¯¦ç»†åˆ†æè¿™æ®µä»£ç ä¸­ Web Audio API çš„å®ç°ç»†èŠ‚ï¼š

## 1. Web Audio API èŠ‚ç‚¹åˆ›å»ºä¸åˆå§‹åŒ–

### AudioContext åˆ›å»º
```javascript
const initAudioContext = useCallback(() => {
  if (!audioContextRef.current) {
    // å…¼å®¹æ€§å¤„ç†ï¼šæ”¯æŒä¸åŒæµè§ˆå™¨
    audioContextRef.current = new (window.AudioContext ||
      (window as any).webkitAudioContext)();

    // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
    gainNodeRef.current = audioContextRef.current.createGain();
    analyserRef.current = audioContextRef.current.createAnalyser();

    // è®¾ç½®åˆå§‹éŸ³é‡
    gainNodeRef.current.gain.value = isMuted ? 0 : volume;

    // æ„å»ºéŸ³é¢‘å¤„ç†é“¾ï¼šsource -> gain -> analyser -> destination
    gainNodeRef.current.connect(analyserRef.current);
    analyserRef.current.connect(audioContextRef.current.destination);

    // é…ç½®åˆ†æå™¨èŠ‚ç‚¹
    analyserRef.current.fftSize = 256;
    
    isInitializedRef.current = true;
  }

  // å¤„ç†æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é™åˆ¶
  if (audioContextRef.current.state === "suspended") {
    audioContextRef.current.resume();
  }
}, [volume, isMuted]);
```

**å…³é”®ç»†èŠ‚ï¼š**
- **æµè§ˆå™¨å…¼å®¹æ€§**ï¼šä½¿ç”¨ `window.AudioContext || window.webkitAudioContext`
- **çŠ¶æ€æ£€æŸ¥**ï¼šå¤„ç† AudioContext çš„ `suspended` çŠ¶æ€
- **éŸ³é¢‘å›¾æ„å»º**ï¼šå»ºç«‹å›ºå®šçš„å¤„ç†é“¾ï¼ŒæºèŠ‚ç‚¹åç»­åŠ¨æ€è¿æ¥

## 2. éŸ³é¢‘åŠ è½½ä¸è§£ç 

### æ ¸å¿ƒåŠ è½½å‡½æ•°
```javascript
const loadAndPlayAudio = useCallback(async (url: string, seekTime: number = 0) => {
  // é˜²é‡å¤åŠ è½½çš„é”æœºåˆ¶
  if (loadingRef.current) return;
  loadingRef.current = true;

  try {
    // 1. è·å–éŸ³é¢‘æ–‡ä»¶
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // 2. è½¬æ¢ä¸º ArrayBuffer
    const arrayBuffer = await response.arrayBuffer();
    
    // 3. è§£ç éŸ³é¢‘æ•°æ®
    const audioBuffer = await audioContextRef.current.decodeAudioData(arrayBuffer);
    audioBufferRef.current = audioBuffer;

    // 4. åˆ›å»ºæ–°çš„éŸ³é¢‘æºèŠ‚ç‚¹ï¼ˆæ¯æ¬¡æ’­æ”¾éƒ½éœ€è¦æ–°å»ºï¼‰
    const source = audioContextRef.current.createBufferSource();
    source.buffer = audioBuffer;
    source.loop = isLoop;
    source.playbackRate.value = playbackRate;

    // 5. è¿æ¥åˆ°éŸ³é¢‘å¤„ç†é“¾
    source.connect(gainNodeRef.current!);
    audioSourceRef.current = source;

    // 6. ä»æŒ‡å®šæ—¶é—´å¼€å§‹æ’­æ”¾
    source.start(0, seekTime);
    
    // æ›´æ–°çŠ¶æ€
    setDuration(audioBuffer.duration);
    setCurrentTime(seekTime);
    setIsPlaying(true);
  } finally {
    loadingRef.current = false;
  }
});
```

## 3. ç²¾ç¡®çš„æ—¶é—´è¿½è¸ªç³»ç»Ÿ

### æ—¶é—´è®¡ç®—é€»è¾‘
```javascript
const updateCurrentTime = useCallback(() => {
  if (audioContextRef.current && isPlaying && audioBufferRef.current && audioSourceRef.current) {
    // è®¡ç®—å·²æ’­æ”¾æ—¶é—´
    const elapsed = audioContextRef.current.currentTime - startTimeRef.current;
    const newCurrentTime = pauseTimeRef.current + elapsed;

    // æ£€æŸ¥æ’­æ”¾æ˜¯å¦ç»“æŸ
    if (newCurrentTime >= audioBufferRef.current.duration) {
      // å¤„ç†å¾ªç¯æˆ–ä¸‹ä¸€é¦–é€»è¾‘
      if (isLoop) {
        pauseTimeRef.current = 0;
        startTimeRef.current = audioContextRef.current.currentTime;
        setCurrentTime(0);
      } else {
        // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
        handleAutoNext();
      }
    } else {
      setCurrentTime(newCurrentTime);
    }

    // ç»§ç»­æ›´æ–°å¾ªç¯
    requestRef.current = requestAnimationFrame(updateCurrentTime);
  }
}, [isPlaying, isLoop, /* other deps */]);
```

**æ—¶é—´è¿½è¸ªçš„å…³é”®ç‚¹ï¼š**
- **`startTimeRef.current`**ï¼šè®°å½•æ’­æ”¾å¼€å§‹çš„ AudioContext æ—¶é—´
- **`pauseTimeRef.current`**ï¼šè®°å½•æš‚åœå‰å·²æ’­æ”¾çš„æ—¶é—´
- **`audioContext.currentTime`**ï¼šè·å–éŸ³é¢‘ä¸Šä¸‹æ–‡çš„ç²¾ç¡®æ—¶é—´
- **è®¡ç®—å…¬å¼**ï¼š`å½“å‰æ—¶é—´ = æš‚åœæ—¶é—´ + (å½“å‰éŸ³é¢‘æ—¶é—´ - å¼€å§‹æ—¶é—´)`

## 4. éŸ³é‡æ§åˆ¶ç³»ç»Ÿ

### å®æ—¶éŸ³é‡è°ƒèŠ‚
```javascript
const handleVolumeChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
  const newVolume = parseFloat(e.target.value);
  setVolume(newVolume);
  
  if (gainNodeRef.current) {
    // ä½¿ç”¨ setValueAtTime è¿›è¡Œå¹³æ»‘éŸ³é‡å˜åŒ–
    gainNodeRef.current.gain.setValueAtTime(
      newVolume,
      audioContextRef.current!.currentTime
    );
  }
  
  setIsMuted(newVolume === 0);
}, []);

// é™éŸ³åˆ‡æ¢
const toggleMute = useCallback(() => {
  const newMuted = !isMuted;
  setIsMuted(newMuted);
  
  if (gainNodeRef.current && audioContextRef.current) {
    const targetVolume = newMuted ? 0 : volume;
    gainNodeRef.current.gain.setValueAtTime(
      targetVolume,
      audioContextRef.current.currentTime
    );
  }
}, [isMuted, volume]);
```

## 5. æ’­æ”¾æ§åˆ¶çš„æ ¸å¿ƒé€»è¾‘

### æ’­æ”¾/æš‚åœæœºåˆ¶
```javascript
const pauseAudio = useCallback(() => {
  if (isPlaying && audioContextRef.current) {
    setIsPlaying(false);

    // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
    const elapsed = audioContextRef.current.currentTime - startTimeRef.current;
    pauseTimeRef.current += elapsed;

    // åœæ­¢å¹¶é”€æ¯å½“å‰æºèŠ‚ç‚¹
    stopCurrentAudio();
  }
}, [isPlaying, stopCurrentAudio]);

// æ¢å¤æ’­æ”¾ï¼šé‡æ–°åˆ›å»ºæºèŠ‚ç‚¹ä»æš‚åœä½ç½®å¼€å§‹
const resumeAudio = () => {
  if (audioBufferRef.current && currentSongIndex !== null) {
    loadAndPlayAudio(urlsList[currentSongIndex], pauseTimeRef.current);
  }
};
```

### è¿›åº¦è·³è½¬
```javascript
const handleProgressClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
  const progressBar = e.currentTarget;
  const rect = progressBar.getBoundingClientRect();
  const clickPosition = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
  const seekTime = (clickPosition / rect.width) * duration;

  // é™åˆ¶è·³è½¬æ—¶é—´èŒƒå›´
  const clampedSeekTime = Math.max(0, Math.min(seekTime, duration - 0.1));

  // æ›´æ–°æ—¶é—´çŠ¶æ€
  setCurrentTime(clampedSeekTime);
  pauseTimeRef.current = clampedSeekTime;

  // é‡æ–°åŠ è½½éŸ³é¢‘ä»æ–°ä½ç½®æ’­æ”¾
  if (currentSongIndex !== null && urlsList[currentSongIndex]) {
    loadAndPlayAudio(urlsList[currentSongIndex], clampedSeekTime);
  }
}, [duration, currentSongIndex, urlsList, loadAndPlayAudio]);
```

## 6. æ’­æ”¾é€Ÿåº¦æ§åˆ¶

```javascript
const changePlaybackRate = useCallback(() => {
  const rates = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
  const currentIndex = rates.indexOf(playbackRate);
  const nextIndex = (currentIndex + 1) % rates.length;
  const newRate = rates[nextIndex];

  setPlaybackRate(newRate);
  
  if (audioSourceRef.current && audioContextRef.current) {
    // å®æ—¶è°ƒæ•´æ’­æ”¾é€Ÿåº¦
    audioSourceRef.current.playbackRate.setValueAtTime(
      newRate,
      audioContextRef.current.currentTime
    );
  }
}, [playbackRate]);
```

## 7. é‡è¦çš„å®ç°ç»†èŠ‚

### 1. AudioBufferSourceNode çš„ä¸€æ¬¡æ€§ç‰¹æ€§
```javascript
// AudioBufferSourceNode åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œæ¯æ¬¡æ’­æ”¾éƒ½éœ€è¦é‡æ–°åˆ›å»º
const source = audioContextRef.current.createBufferSource();
source.buffer = audioBuffer;
source.start(0, seekTime);  // å¼€å§‹æ’­æ”¾åå°±ä¸èƒ½é‡ç”¨

// æš‚åœæ—¶å¿…é¡»åœæ­¢å¹¶é‡æ–°åˆ›å»º
source.stop();  // åœæ­¢åè¿™ä¸ªèŠ‚ç‚¹å°±åºŸå¼ƒäº†
```

### 2. é˜²é‡å¤åŠ è½½æœºåˆ¶
```javascript
const loadingRef = useRef<boolean>(false);

const loadAndPlayAudio = async (url: string) => {
  if (loadingRef.current) return;  // é˜²æ­¢å¹¶å‘åŠ è½½
  loadingRef.current = true;
  
  try {
    // åŠ è½½é€»è¾‘
  } finally {
    loadingRef.current = false;  // ç¡®ä¿çŠ¶æ€é‡ç½®
  }
};
```

### 3. èµ„æºæ¸…ç†
```javascript
const stopCurrentAudio = useCallback(() => {
  if (audioSourceRef.current) {
    try {
      audioSourceRef.current.stop();
      audioSourceRef.current.disconnect();  // æ–­å¼€è¿æ¥é‡Šæ”¾å†…å­˜
    } catch (error) {
      // å¿½ç•¥å·²åœæ­¢èŠ‚ç‚¹çš„é”™è¯¯
    }
    audioSourceRef.current = null;
  }
  
  if (requestRef.current) {
    cancelAnimationFrame(requestRef.current);  // åœæ­¢åŠ¨ç”»å¾ªç¯
    requestRef.current = null;
  }
}, []);

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†
useEffect(() => {
  return () => {
    stopCurrentAudio();
    if (audioContextRef.current?.state !== "closed") {
      audioContextRef.current.close();  // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
    }
  };
}, [stopCurrentAudio]);
```

### 4. å¾ªç¯æ’­æ”¾çš„å¤„ç†
```javascript
// åœ¨æºèŠ‚ç‚¹ä¸Šè®¾ç½®å¾ªç¯
source.loop = isLoop;

// æ‰‹åŠ¨å¤„ç†å¾ªç¯ï¼ˆæ›´å¯æ§ï¼‰
source.onended = () => {
  if (audioSourceRef.current === source && isLoop) {
    setTimeout(() => {
      if (audioSourceRef.current === source) {
        loadAndPlayAudio(url, 0);  // é‡æ–°å¼€å§‹
      }
    }, 10);
  }
};
```

## 8. æ¶æ„ä¼˜åŠ¿

1. **ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶**ï¼šåŸºäº AudioContext.currentTime è€Œä¸æ˜¯ Date.now()
2. **ä½å»¶è¿Ÿ**ï¼šWeb Audio API ç›´æ¥æ“ä½œéŸ³é¢‘ç¼“å†²åŒº
3. **å®æ—¶å¤„ç†**ï¼šæ”¯æŒå®æ—¶éŸ³é‡ã€é€Ÿåº¦è°ƒèŠ‚
4. **æ‰©å±•æ€§å¼º**ï¼šæ˜“äºæ·»åŠ å‡è¡¡å™¨ã€æ•ˆæœå™¨ç­‰éŸ³é¢‘å¤„ç†
5. **æ€§èƒ½ä¼˜ç§€**ï¼šä½¿ç”¨ requestAnimationFrame ä¼˜åŒ– UI æ›´æ–°

è¿™ä¸ªå®ç°å±•ç°äº† Web Audio API åœ¨ä¸“ä¸šéŸ³é¢‘åº”ç”¨ä¸­çš„å¼ºå¤§èƒ½åŠ›ï¼Œé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„çŠ¶æ€ç®¡ç†å’Œèµ„æºå¤„ç†ï¼Œå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜ç§€çš„éŸ³é¢‘æ’­æ”¾å™¨ã€‚



Claude:
ï¿½ï¿½äºä½ æä¾›çš„éŸ³ä¹æ’­æ”¾å™¨ä»£ç ï¼Œæˆ‘æ¥è¯¦ç»†è®²è§£å…¶ä¸­ **Web Audio API** çš„ä½¿ç”¨æ–¹å¼å’Œå…³é”®ç»†èŠ‚ï¼š

## 1. Web Audio API çš„åˆ›å»ºå’Œåˆå§‹åŒ–

### AudioContext åˆ›å»º
```javascript
const initAudioContext = useCallback(() => {
  if (!audioContextRef.current) {
    // å…¼å®¹æ€§å¤„ç†ï¼šæ”¯æŒä¸åŒæµè§ˆå™¨çš„AudioContext
    audioContextRef.current = new (window.AudioContext ||
      (window as any).webkitAudioContext)();

    // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
    gainNodeRef.current = audioContextRef.current.createGain();
    analyserRef.current = audioContextRef.current.createAnalyser();

    // è®¾ç½®åˆå§‹éŸ³é‡
    gainNodeRef.current.gain.value = isMuted ? 0 : volume;

    // æ„å»ºéŸ³é¢‘å›¾ï¼šsource -> gain -> analyser -> destination
    gainNodeRef.current.connect(analyserRef.current);
    analyserRef.current.connect(audioContextRef.current.destination);

    // é…ç½®åˆ†æå™¨èŠ‚ç‚¹
    analyserRef.current.fftSize = 256;
    isInitializedRef.current = true;
  }

  // å¤„ç†æµè§ˆå™¨çš„è‡ªåŠ¨æ’­æ”¾æ”¿ç­–
  if (audioContextRef.current.state === "suspended") {
    audioContextRef.current.resume();
  }
}, [volume, isMuted]);
```

**å…³é”®ç»†èŠ‚ï¼š**
- **å•ä¾‹æ¨¡å¼**ï¼šç¡®ä¿æ•´ä¸ªç»„ä»¶åªåˆ›å»ºä¸€ä¸ª AudioContext
- **æ‡’åŠ è½½**ï¼šåªåœ¨çœŸæ­£éœ€è¦æ’­æ”¾æ—¶æ‰åˆå§‹åŒ–
- **æµè§ˆå™¨å…¼å®¹æ€§**ï¼šå¤„ç† `webkitAudioContext` å‰ç¼€
- **è‡ªåŠ¨æ’­æ”¾ç­–ç•¥**ï¼šç°ä»£æµè§ˆå™¨è¦æ±‚ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾éŸ³é¢‘

## 2. éŸ³é¢‘èŠ‚ç‚¹æ¶æ„

### éŸ³é¢‘å›¾ç»“æ„
```
AudioBufferSource â†’ GainNode â†’ AnalyserNode â†’ Destination
      â†“              â†“            â†“             â†“
   éŸ³é¢‘æº         éŸ³é‡æ§åˆ¶      éŸ³é¢‘åˆ†æ      æ‰¬å£°å™¨è¾“å‡º
```

### èŠ‚ç‚¹åˆ›å»ºå’Œé…ç½®
```javascript
// åˆ›å»ºéŸ³é¢‘æºèŠ‚ç‚¹ï¼ˆæ¯æ¬¡æ’­æ”¾éƒ½è¦é‡æ–°åˆ›å»ºï¼‰
const source = audioContextRef.current.createBufferSource();
source.buffer = audioBuffer;           // è®¾ç½®éŸ³é¢‘æ•°æ®
source.loop = isLoop;                 // å¾ªç¯æ’­æ”¾è®¾ç½®
source.playbackRate.value = playbackRate; // æ’­æ”¾é€Ÿåº¦

// è¿æ¥åˆ°éŸ³é¢‘å›¾
source.connect(gainNodeRef.current!);
```

## 3. éŸ³é‡æ§åˆ¶ç³»ç»Ÿ

### å®æ—¶éŸ³é‡è°ƒèŠ‚
```javascript
const handleVolumeChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
  const newVolume = parseFloat(e.target.value);
  setVolume(newVolume);
  
  if (gainNodeRef.current) {
    // ä½¿ç”¨ setValueAtTime å®ç°å¹³æ»‘éŸ³é‡å˜åŒ–
    gainNodeRef.current.gain.setValueAtTime(
      newVolume,
      audioContextRef.current!.currentTime
    );
  }
  setIsMuted(newVolume === 0);
}, []);
```

### é™éŸ³åŠŸèƒ½
```javascript
const toggleMute = useCallback(() => {
  const newMuted = !isMuted;
  setIsMuted(newMuted);
  
  if (gainNodeRef.current && audioContextRef.current) {
    const targetVolume = newMuted ? 0 : volume;
    // ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶ï¼Œé¿å…éŸ³é¢‘çˆ†éŸ³
    gainNodeRef.current.gain.setValueAtTime(
      targetVolume,
      audioContextRef.current.currentTime
    );
  }
}, [isMuted, volume]);
```

## 4. ç²¾ç¡®çš„æ—¶é—´è·Ÿè¸ªæœºåˆ¶

### æ’­æ”¾æ—¶é—´è®¡ç®—
```javascript
const updateCurrentTime = useCallback(() => {
  if (audioContextRef.current && isPlaying && audioBufferRef.current && audioSourceRef.current) {
    // æ ¸å¿ƒæ—¶é—´è®¡ç®—å…¬å¼
    const elapsed = audioContextRef.current.currentTime - startTimeRef.current;
    const newCurrentTime = pauseTimeRef.current + elapsed;
    
    // æ£€æŸ¥æ’­æ”¾ç»“æŸ
    if (newCurrentTime >= audioBufferRef.current.duration) {
      // å¤„ç†å¾ªç¯æˆ–ä¸‹ä¸€é¦–é€»è¾‘
    } else {
      setCurrentTime(newCurrentTime);
    }
    
    // ä½¿ç”¨ requestAnimationFrame å®ç°é«˜ç²¾åº¦æ›´æ–°
    requestRef.current = requestAnimationFrame(updateCurrentTime);
  }
}, [/* ä¾èµ–é¡¹ */]);
```

**æ—¶é—´è·Ÿè¸ªçš„å…³é”®å˜é‡ï¼š**
- `startTimeRef.current`ï¼šè®°å½•æ’­æ”¾å¼€å§‹çš„ AudioContext æ—¶é—´
- `pauseTimeRef.current`ï¼šç´¯è®¡çš„æš‚åœæ—¶é—´
- `audioContextRef.current.currentTime`ï¼šAudioContext çš„ç»å¯¹æ—¶é—´

## 5. æš‚åœå’Œæ¢å¤æœºåˆ¶

### æš‚åœå®ç°
```javascript
const pauseAudio = useCallback(() => {
  if (isPlaying && audioContextRef.current) {
    setIsPlaying(false);
    
    // è®¡ç®—å¹¶ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
    const elapsed = audioContextRef.current.currentTime - startTimeRef.current;
    pauseTimeRef.current += elapsed;
    
    // åœæ­¢å¹¶æ¸…ç†å½“å‰éŸ³é¢‘æº
    stopCurrentAudio();
  }
}, [isPlaying, stopCurrentAudio]);
```

### æ¢å¤æ’­æ”¾
```javascript
// ä»æš‚åœä½ç½®æ¢å¤æ’­æ”¾
if (audioBufferRef.current && currentSongIndex !== null && urlsList[currentSongIndex]) {
  await loadAndPlayAudio(urlsList[currentSongIndex], pauseTimeRef.current);
}
```

**é‡è¦ç»†èŠ‚ï¼š** Web Audio API çš„ `AudioBufferSourceNode` æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæš‚åœåå¿…é¡»é‡æ–°åˆ›å»ºã€‚

## 6. éŸ³é¢‘åŠ è½½å’Œæ’­æ”¾æµç¨‹

### å®Œæ•´çš„åŠ è½½æµç¨‹
```javascript
const loadAndPlayAudio = useCallback(async (url: string, seekTime: number = 0) => {
  // 1. é˜²é‡å¤åŠ è½½
  if (loadingRef.current) return;
  loadingRef.current = true;

  try {
    // 2. ç¡®ä¿ AudioContext å·²åˆå§‹åŒ–
    if (!isInitializedRef.current) {
      initAudioContext();
    }

    // 3. åœæ­¢å½“å‰æ’­æ”¾
    stopCurrentAudio();

    // 4. è·å–å¹¶è§£ç éŸ³é¢‘æ•°æ®
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();
    const audioBuffer = await audioContextRef.current.decodeAudioData(arrayBuffer);
    audioBufferRef.current = audioBuffer;

    // 5. åˆ›å»ºæ–°çš„éŸ³é¢‘æº
    const source = audioContextRef.current.createBufferSource();
    source.buffer = audioBuffer;
    source.loop = isLoop;
    source.playbackRate.value = playbackRate;

    // 6. è¿æ¥éŸ³é¢‘å›¾
    source.connect(gainNodeRef.current!);
    audioSourceRef.current = source;

    // 7. è®¾ç½®æ’­æ”¾å‚æ•°
    pauseTimeRef.current = seekTime;
    startTimeRef.current = audioContextRef.current.currentTime;

    // 8. å¼€å§‹æ’­æ”¾
    source.start(0, seekTime);

    // 9. æ›´æ–°çŠ¶æ€
    setDuration(audioBuffer.duration);
    setCurrentTime(seekTime);
    setIsPlaying(true);

  } catch (error) {
    console.error("Error loading audio:", error);
    setIsPlaying(false);
  } finally {
    loadingRef.current = false;
  }
}, [/* ä¾èµ–é¡¹ */]);
```

## 7. æ’­æ”¾é€Ÿåº¦æ§åˆ¶

```javascript
const changePlaybackRate = useCallback(() => {
  const rates = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
  const currentIndex = rates.indexOf(playbackRate);
  const nextIndex = (currentIndex + 1) % rates.length;
  const newRate = rates[nextIndex];

  setPlaybackRate(newRate);
  
  if (audioSourceRef.current && audioContextRef.current) {
    // å®æ—¶æ›´æ”¹æ’­æ”¾é€Ÿåº¦
    audioSourceRef.current.playbackRate.setValueAtTime(
      newRate,
      audioContextRef.current.currentTime
    );
  }
}, [playbackRate]);
```

## 8. è¿›åº¦æ¡æ§åˆ¶

```javascript
const handleProgressClick = useCallback((e: React.MouseEvent<HTMLDivElement>) => {
  // è®¡ç®—ç‚¹å‡»ä½ç½®å¯¹åº”çš„æ—¶é—´
  const progressBar = e.currentTarget;
  const rect = progressBar.getBoundingClientRect();
  const clickPosition = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
  const seekTime = (clickPosition / rect.width) * duration;

  // è¾¹ç•Œæ£€æŸ¥
  const clampedSeekTime = Math.max(0, Math.min(seekTime, duration - 0.1));

  // æ›´æ–°æ’­æ”¾ä½ç½®
  setCurrentTime(clampedSeekTime);
  pauseTimeRef.current = clampedSeekTime;

  if (currentSongIndex !== null && urlsList[currentSongIndex]) {
    if (isPlaying || audioSourceRef.current) {
      // é‡æ–°åŠ è½½å¹¶è·³è½¬åˆ°æŒ‡å®šä½ç½®
      loadAndPlayAudio(urlsList[currentSongIndex], clampedSeekTime);
    }
  }
}, [/* ä¾èµ–é¡¹ */]);
```

## 9. èµ„æºç®¡ç†å’Œæ¸…ç†

### åœæ­¢æ’­æ”¾
```javascript
const stopCurrentAudio = useCallback(() => {
  if (audioSourceRef.current) {
    try {
      audioSourceRef.current.stop();      // åœæ­¢æ’­æ”¾
      audioSourceRef.current.disconnect(); // æ–­å¼€è¿æ¥
    } catch (error) {
      // å¿½ç•¥å·²åœæ­¢èŠ‚ç‚¹çš„é”™è¯¯
    }
    audioSourceRef.current = null;
  }
  
  if (requestRef.current) {
    cancelAnimationFrame(requestRef.current); // å–æ¶ˆåŠ¨ç”»å¸§
    requestRef.current = null;
  }

  // é‡ç½®æ—¶é—´çŠ¶æ€
  startTimeRef.current = 0;
  pauseTimeRef.current = 0;
}, []);
```

### ç»„ä»¶å¸è½½æ—¶æ¸…ç†
```javascript
useEffect(() => {
  return () => {
    stopCurrentAudio();
    if (audioContextRef.current && audioContextRef.current.state !== "closed") {
      audioContextRef.current.close(); // å…³é—­ AudioContext
    }
  };
}, [stopCurrentAudio]);
```

## 10. å…³é”®ç»†èŠ‚å’Œæœ€ä½³å®è·µ

### é˜²é‡å¤åŠ è½½
```javascript
const loadingRef = useRef<boolean>(false);

if (loadingRef.current) {
  return; // é˜²æ­¢å¹¶å‘åŠ è½½
}
loadingRef.current = true;
```

### èŠ‚ç‚¹å¼•ç”¨éªŒè¯
```javascript
// ç¡®ä¿æ“ä½œçš„æ˜¯å½“å‰æœ‰æ•ˆçš„æºèŠ‚ç‚¹
if (audioSourceRef.current === source) {
  // æ‰§è¡Œæ“ä½œ
}
```

### å¼‚æ­¥æ“ä½œçš„æ—¶æœºæ§åˆ¶
```javascript
// å»¶è¿Ÿå¯åŠ¨æ›´æ–°å¾ªç¯ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
setTimeout(() => {
  if (audioSourceRef.current === source) {
    requestRef.current = requestAnimationFrame(startUpdateLoop);
  }
}, 10);
```

### é”™è¯¯å¤„ç†
```javascript
try {
  audioSourceRef.current.stop();
  audioSourceRef.current.disconnect();
} catch (error) {
  // å¿½ç•¥å·²åœæ­¢èŠ‚ç‚¹çš„é”™è¯¯ï¼Œé¿å…æ§åˆ¶å°æŠ¥é”™
}
```

è¿™ä¸ªå®ç°å±•ç¤ºäº† Web Audio API åœ¨å®é™…éŸ³ä¹æ’­æ”¾å™¨ä¸­çš„ä¸“ä¸šçº§åº”ç”¨ï¼ŒåŒ…å«äº†ç²¾ç¡®çš„æ—¶é—´æ§åˆ¶ã€æµç•…çš„ç”¨æˆ·äº¤äº’ã€å®Œå–„çš„èµ„æºç®¡ç†ç­‰å…³é”®ç‰¹æ€§ã€‚


ç”¨æˆ·:
const audioContextRef = useRef<AudioContext | null>(null);   const audioSourceRef = useRef<AudioBufferSourceNode | null>(null);   const gainNodeRef = useRef<GainNode | null>(null);   const analyserRef = useRef<AnalyserNode | null>(null);   const audioBufferRef = useRef<AudioBuffer | null>(null);   const requestRef = useRef<number | null>(null);ä¸ºä»€ä¹ˆéƒ½è¦ç”¨useRef

Claude:
ï¿½ï¿½æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼åœ¨è¿™ä¸ªéŸ³ä¹æ’­æ”¾å™¨ä¸­ï¼Œæ‰€æœ‰Web Audio APIç›¸å…³çš„å¯¹è±¡éƒ½ä½¿ç”¨ `useRef` è€Œä¸æ˜¯ `useState`ï¼Œè¿™æœ‰å‡ ä¸ªé‡è¦çš„åŸå› ï¼š

## 1. **å¼•ç”¨ç¨³å®šæ€§** - è·¨æ¸²æŸ“ä¿æŒåŒä¸€å®ä¾‹

```javascript
// âŒ å¦‚æœä½¿ç”¨ useState
const [audioContext, setAudioContext] = useState<AudioContext | null>(null);

// æ¯æ¬¡ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œå¯èƒ½ä¼šåˆ›å»ºæ–°çš„ AudioContext
// è¿™ä¼šå¯¼è‡´éŸ³é¢‘æ’­æ”¾ä¸­æ–­å’Œèµ„æºæµªè´¹

// âœ… ä½¿ç”¨ useRef
const audioContextRef = useRef<AudioContext | null>(null);

// audioContextRef.current åœ¨æ•´ä¸ªç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…æŒ‡å‘åŒä¸€ä¸ª AudioContext å®ä¾‹
// æ— è®ºç»„ä»¶é‡æ–°æ¸²æŸ“å¤šå°‘æ¬¡ï¼Œéƒ½ä¸ä¼šæ”¹å˜
```

## 2. **é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“**

```javascript
// âŒ useState ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
const [audioSource, setAudioSource] = useState<AudioBufferSourceNode | null>(null);

// æ¯æ¬¡ setAudioSource éƒ½ä¼šè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
// ä½†éŸ³é¢‘èŠ‚ç‚¹çš„å˜åŒ–é€šå¸¸ä¸éœ€è¦æ›´æ–°UI

// âœ… useRef ä¸è§¦å‘é‡æ–°æ¸²æŸ“
const audioSourceRef = useRef<AudioBufferSourceNode | null>(null);

// audioSourceRef.current = newSource ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“
// è¿™æ ·å¯ä»¥é¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€
```

## 3. **åœ¨å¼‚æ­¥æ“ä½œä¸­ä¿æŒå¼•ç”¨ä¸€è‡´æ€§**

```javascript
const loadAndPlayAudio = useCallback(async (url: string) => {
  // åœ¨å¼‚æ­¥æ“ä½œè¿‡ç¨‹ä¸­ï¼Œç»„ä»¶å¯èƒ½é‡æ–°æ¸²æŸ“å¤šæ¬¡
  // ä½†æˆ‘ä»¬éœ€è¦ç¡®ä¿æ“ä½œçš„æ˜¯åŒä¸€ä¸ªéŸ³é¢‘èŠ‚ç‚¹
  
  const source = audioContextRef.current!.createBufferSource();
  audioSourceRef.current = source;
  
  // å³ä½¿åœ¨ fetch å’Œ decodeAudioData æœŸé—´ç»„ä»¶é‡æ–°æ¸²æŸ“
  // audioSourceRef.current ä»ç„¶æŒ‡å‘æ­£ç¡®çš„èŠ‚ç‚¹
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  const audioBuffer = await audioContextRef.current!.decodeAudioData(arrayBuffer);
  
  // ç¡®ä¿æˆ‘ä»¬æ“ä½œçš„è¿˜æ˜¯åŒä¸€ä¸ªæºèŠ‚ç‚¹
  if (audioSourceRef.current === source) {
    source.buffer = audioBuffer;
    source.start();
  }
}, []);
```

## 4. **åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­è®¿é—®æœ€æ–°å€¼**

```javascript
// âœ… useRef å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è®¿é—®æœ€æ–°å€¼
const handleProgressClick = useCallback((e: React.MouseEvent) => {
  // audioBufferRef.current æ€»æ˜¯æŒ‡å‘å½“å‰çš„éŸ³é¢‘ç¼“å†²åŒº
  if (!audioBufferRef.current || !duration) return;
  
  const seekTime = calculateSeekTime(e);
  
  // å¯ä»¥ç›´æ¥ä½¿ç”¨å½“å‰çš„éŸ³é¢‘èŠ‚ç‚¹
  if (audioSourceRef.current) {
    audioSourceRef.current.stop();
  }
  
  // åˆ›å»ºæ–°çš„æ’­æ”¾
  loadAndPlayAudio(url, seekTime);
}, []);

// âŒ å¦‚æœä½¿ç”¨ useStateï¼Œå¯èƒ½ä¼šæœ‰é—­åŒ…é™·é˜±
const [audioBuffer, setAudioBuffer] = useState<AudioBuffer | null>(null);

const handleClick = useCallback(() => {
  // è¿™é‡Œçš„ audioBuffer å¯èƒ½æ˜¯æ—§çš„å€¼ï¼ˆé—­åŒ…é™·é˜±ï¼‰
  if (!audioBuffer) return; // å¯èƒ½æ‹¿åˆ°çš„æ˜¯æ—§çŠ¶æ€
}, []); // ç©ºä¾èµ–æ•°ç»„å¯¼è‡´é—­åŒ…é™·é˜±
```

## 5. **èµ„æºæ¸…ç†çš„ä¸€è‡´æ€§**

```javascript
useEffect(() => {
  return () => {
    // ç»„ä»¶å¸è½½æ—¶éœ€è¦æ¸…ç†èµ„æº
    // useRef ç¡®ä¿æˆ‘ä»¬æ¸…ç†çš„æ˜¯æ­£ç¡®çš„å®ä¾‹
    
    if (audioSourceRef.current) {
      audioSourceRef.current.stop();
      audioSourceRef.current.disconnect();
    }
    
    if (audioContextRef.current && audioContextRef.current.state !== "closed") {
      audioContextRef.current.close();
    }
    
    if (requestRef.current) {
      cancelAnimationFrame(requestRef.current);
    }
  };
}, []);
```

## 6. **åŠ¨ç”»å¸§å¤„ç†**

```javascript
const requestRef = useRef<number | null>(null);

const updateCurrentTime = useCallback(() => {
  // è®¡ç®—æ’­æ”¾æ—¶é—´
  const newTime = calculateCurrentTime();
  setCurrentTime(newTime);
  
  // ä¿å­˜åŠ¨ç”»å¸§IDï¼Œä»¥ä¾¿åç»­å–æ¶ˆ
  requestRef.current = requestAnimationFrame(updateCurrentTime);
}, []);

const stopAnimation = () => {
  if (requestRef.current) {
    cancelAnimationFrame(requestRef.current); // éœ€è¦ä½¿ç”¨ä¿å­˜çš„ID
    requestRef.current = null;
  }
};
```

## æ€»ç»“å¯¹æ¯”

| ç‰¹æ€§ | useState | useRef |
|------|----------|---------|
| è§¦å‘é‡æ–°æ¸²æŸ“ | âœ… æ˜¯ | âŒ å¦ |
| è·¨æ¸²æŸ“ä¿æŒå¼•ç”¨ | âŒ å¦ | âœ… æ˜¯ |
| é€‚åˆUIçŠ¶æ€ | âœ… æ˜¯ | âŒ å¦ |
| é€‚åˆDOM/APIå¼•ç”¨ | âŒ å¦ | âœ… æ˜¯ |
| é—­åŒ…é™·é˜±é£é™© | âš ï¸ æœ‰ | âŒ æ—  |

## æ ¸å¿ƒåŸåˆ™

åœ¨è¿™ä¸ªéŸ³ä¹æ’­æ”¾å™¨ä¸­ï¼Œ**çŠ¶æ€**å’Œ**å¼•ç”¨**æœ‰æ˜ç¡®çš„åˆ†å·¥ï¼š

```javascript
// ğŸ¯ UIç›¸å…³çš„çŠ¶æ€ - ä½¿ç”¨ useState
const [isPlaying, setIsPlaying] = useState(false);     // å½±å“æ’­æ”¾æŒ‰é’®æ˜¾ç¤º
const [currentTime, setCurrentTime] = useState(0);     // å½±å“è¿›åº¦æ¡æ˜¾ç¤º
const [volume, setVolume] = useState(0.7);            // å½±å“éŸ³é‡æ»‘å—æ˜¾ç¤º

// ğŸ”— åº•å±‚APIå¯¹è±¡å¼•ç”¨ - ä½¿ç”¨ useRef
const audioContextRef = useRef<AudioContext | null>(null);     // Web Audio APIå®ä¾‹
const audioSourceRef = useRef<AudioBufferSourceNode | null>(null); // éŸ³é¢‘æºèŠ‚ç‚¹
const gainNodeRef = useRef<GainNode | null>(null);            // éŸ³é‡æ§åˆ¶èŠ‚ç‚¹
```

**ç®€å•æ¥è¯´ï¼šéœ€è¦å½±å“UIæ¸²æŸ“çš„ç”¨`useState`ï¼Œéœ€è¦æŒä¹…å¼•ç”¨åº•å±‚å¯¹è±¡çš„ç”¨`useRef`ã€‚**


